<% layout('layouts/boilerplate') %>
  <%- include('../partials/navbar') %>
    <%- include('../partials/flash') %>

      <div class="container py-4">
        <h2 class="mb-4">ðŸ›’ My Cart</h2>

        <% if (user.cart && user.cart.length> 0) { %>

          <table class="table table-bordered bg-white">
            <thead class="table-secondary">
              <tr>
                <th>Product</th>
                <th>Price (â‚¹)</th>
                <th>Quantity</th>
                <th>Subtotal (â‚¹)</th>
                <th>Action</th>
              </tr>
            </thead>

            <tbody>
              <% let total=0; %>

                <% user.cart.forEach(item=> { %>
                  <% let subtotal=item.product.price * item.quantity; %>
                    <% total +=subtotal; %>

                      <tr>
                        <td class="d-flex align-items-center gap-3">
                          <img src="<%= item.product.img %>" class="img-thumbnail"
                            style="width:100px; height:100px; object-fit:cover;">
                          <span>
                            <%= item.product.name %>
                          </span>
                        </td>


                        <td>â‚¹ <%= item.product.price.toFixed(2) %>
                        </td>

                        <td>
                          <form action="/user/cart/update/<%= item.product._id %>" method="POST" class="d-flex">
                            <button class="btn btn-sm btn-outline-dark" name="action" value="decrease">âˆ’</button>
                            <input type="number" name="quantity" value="<%= item.quantity %>"
                              class="form-control form-control-sm text-center mx-1" style="width:60px;">
                            <button class="btn btn-sm btn-outline-dark" name="action" value="increase">+</button>
                          </form>
                        </td>

                        <td>â‚¹ <%= subtotal.toFixed(2) %>
                        </td>

                        <td>
                          <form action="/user/cart/remove/<%= item.product._id %>" method="POST">
                            <button class="btn btn-sm btn-danger">Remove</button>
                          </form>
                        </td>
                      </tr>

                      <% }) %>
            </tbody>
          </table>

          <div class="text-end">
            <h3>Total: â‚¹ <%= total.toFixed(2) %>
            </h3>

            <!-- PayUMoney Payment Form -->
            <form action="/payment_gateway/payumoney" method="POST" class="d-inline">
              <input type="hidden" name="amount" value="<%= total.toFixed(2) %>" />
              <input type="hidden" name="phone" value="<%= user.phone %>" />
              <input type="hidden" name="productinfo" value="<%= productinfo %>" />
              <input type="hidden" name="service_provider" value="payu_paisa" />

              <button class="btn btn-success btn-lg mt-2">Pay Now</button>
            </form>

            <a href="/products" class="btn btn-primary btn-lg mt-2">Continue Shopping</a>
          </div>

          <% } else { %>

            <div class="alert alert-info text-center">
              Your cart is empty ðŸ˜” <br>
              <a href="/products" class="btn btn-primary mt-3">Go shopping</a>
            </div>

            <% } %>
      </div>